---
layout: post
image: Fire.png
title: Fire
sub-title: Canvas Demo Effect
date: 2017-10-17T02:00:00.000Z
tags: HTML5 Javascript Canvas Demo Effect
---
<canvas width="256" height="256" id="canvas"></canvas>
<p>
  This is an HTML5 Canvas version of the 2D fire effect used in many old-school
  coding demos. Normally it's done using an 8-bit indexed color graphics mode,
  but I chose to do it a little differently here using a 32-bit color canvas.
  The Effect looks pretty much the same.
</p>
<p>
  There's a few Canvas specific optimization techniques in the code. Double
  buffering to smooth out the rendering, pre-calculating the y offset values of
  each line, and manipulating the pixels directly in the main loop rather than
  calling a putpixel function all help to make it run as fast and smooth as
  possible (Well over 100fps on my dual-core laptop).
</p>
<p>
  Adapted from original post created on <time>2012-11-04</time>.
</p>
<pre class="highlight">
var canvas, context2D, buffer, width, height, bufferSize;
var turbulence = {}, yIndex = {}, count = 0;

window.onload = function ()
{
	//Get context, precalc some variables, and create screen buffer
	canvas = document.getElementById('canvas');
	context2D = canvas.getContext('2d');
	width = canvas.width;
	height = canvas.height;
	bufferSize = width*height;
	buffer = context2D.createImageData(canvas.width, canvas.height);
	turbulence = context2D.createImageData(canvas.width, canvas.height);

	//Precalc y*width values for each horizontal line
	for(var y = 0; y < height; y++)
		yIndex[y] = y*width;

	//Precalc random turbulence values
	for(var i = 0; i < bufferSize; i++)
		turbulence[i] = Math.random()+0.5;

  requestAnimationFrame(update);
}

function update()
{
	//Fill bottom line of buffer with random fire colors
	for(x = 0; x < width; x++) {
		var index = (yIndex[height-1] + x) << 2;
		var c = Math.floor(Math.random()*255);
		buffer.data[index++] = c << 1;			// r * 2
		buffer.data[index++] = c;				// g
		buffer.data[index++] = c >> 1;			// b / 2
		buffer.data[index++] = 255;				// a
	}

	//Loop through buffer averaging pixels left, right, and below current
	var index;
	for(y = height-2; y > 0; y--) {
		for(x = 0; x < width; x++) {
			index = (yIndex[y] + x-1) << 2;		//x-1 = left
			var r1 = buffer.data[index++];
			var g1 = buffer.data[index++];
			var b1 = buffer.data[index++];

			index = (yIndex[y] + x+1) << 2;		//x+1 = right
			var r2 = buffer.data[index++];
			var g2 = buffer.data[index++];
			var b2 = buffer.data[index++];

			index = (yIndex[y+1] + x) << 2;		//y+1 = below
			var r3 = buffer.data[index++];
			var g3 = buffer.data[index++];
			var b3 = buffer.data[index++];

			index = (yIndex[y] + x) << 2;		//current pixel
			var t = turbulence[((yIndex[y] + x)+(count))%bufferSize];

			//Average pixels, add turbulence, & write to buffer
			buffer.data[index++] = (r1+r2 >> 1)*t + r3 >> 1;
			buffer.data[index++] = (g1+g2 >> 1)*t + g3 >> 1;
			buffer.data[index++] = (b1+b2 >> 1)*t + b3 >> 1;
			buffer.data[index++] = 255;
		}
	}

	//Move turbulence index a random amount each frame
	count += Math.floor(Math.random()*bufferSize);

	//Flip buffer to canvas
	context2D.putImageData(buffer, 0,0);
  requestAnimationFrame(update);
}
</pre>

<script>
var canvas, context2D, buffer, width, height, bufferSize;
var turbulence = {}, yIndex = {}, count = 0;

window.onload = function ()
{
	//Get context, precalc some variables, and create screen buffer
	canvas = document.getElementById('canvas');
	context2D = canvas.getContext('2d');
	width = canvas.width;
	height = canvas.height;
	bufferSize = width*height;
	buffer = context2D.createImageData(canvas.width, canvas.height);
	turbulence = context2D.createImageData(canvas.width, canvas.height);

	//Precalc y*width values for each horizontal line
	for(var y = 0; y < height; y++)
		yIndex[y] = y*width;

	//Precalc random turbulence values
	for(var i = 0; i < bufferSize; i++)
		turbulence[i] = Math.random()+0.5;

  requestAnimationFrame(update);
}

function update()
{
	//Fill bottom line of buffer with random fire colors
	for(x = 0; x < width; x++) {
		var index = (yIndex[height-1] + x) << 2;
		var c = Math.floor(Math.random()*255);
		buffer.data[index++] = c << 1;			// r * 2
		buffer.data[index++] = c;				// g
		buffer.data[index++] = c >> 1;			// b / 2
		buffer.data[index++] = 255;				// a
	}

	//Loop through buffer averaging pixels left, right, and below current
	var index;
	for(y = height-2; y > 0; y--) {
		for(x = 0; x < width; x++) {
			index = (yIndex[y] + x-1) << 2;		//x-1 = left
			var r1 = buffer.data[index++];
			var g1 = buffer.data[index++];
			var b1 = buffer.data[index++];

			index = (yIndex[y] + x+1) << 2;		//x+1 = right
			var r2 = buffer.data[index++];
			var g2 = buffer.data[index++];
			var b2 = buffer.data[index++];

			index = (yIndex[y+1] + x) << 2;		//y+1 = below
			var r3 = buffer.data[index++];
			var g3 = buffer.data[index++];
			var b3 = buffer.data[index++];

			index = (yIndex[y] + x) << 2;		//current pixel
			var t = turbulence[((yIndex[y] + x)+(count))%bufferSize];

			//Average pixels, add turbulence, & write to buffer
			buffer.data[index++] = (r1+r2 >> 1)*t + r3 >> 1;
			buffer.data[index++] = (g1+g2 >> 1)*t + g3 >> 1;
			buffer.data[index++] = (b1+b2 >> 1)*t + b3 >> 1;
			buffer.data[index++] = 255;
		}
	}

	//Move turbulence index a random amount each frame
	count += Math.floor(Math.random()*bufferSize);

	//Flip buffer to canvas
	context2D.putImageData(buffer, 0,0);
  requestAnimationFrame(update);
}
</script>
