<html>
<template id="template">
  <style>
    :host {
      display: block;
      perspective: 25rem;
      /*overflow: hidden;*/
    }
    #container {
      height: 9rem;
      /*pointer-events: none;*/
      transform-style: preserve-3d;
      will-change: transform opacity;
      -webkit-transform: rotateY(calc(var(--x-offset) * -35deg)) rotateX(calc(var(--y-offset) * 35deg));
      -moz-transform: rotateY(calc(var(--x-offset) * -35deg)) rotateX(calc(var(--y-offset) * 35deg));
      -o-transform: rotateY(calc(var(--x-offset) * -35deg)) rotateX(calc(var(--y-offset) * 35deg));
      transform: rotateY(calc(var(--x-offset) * -35deg)) rotateX(calc(var(--y-offset) * 35deg));
      -webkit-transition: transform var(--animation-speed) ease-out;
      -moz-transition: transform var(--animation-speed) ease-out;
      -o-transition: transform var(--animation-speed) ease-out;
      transition: transform var(--animation-speed) ease-out;
    }
    .slow {
      -webkit-transition: transform calc(var(--animation-speed) * 8) ease-out;
      -moz-transition: transform calc(var(--animation-speed) * 8) ease-out;
      -o-transition: transform calc(var(--animation-speed) * 8) ease-out;
      transition: transform calc(var(--animation-speed) * 8) ease-out;
    }
    #gradient {
      content: "";
      top: 0;
      z-index: 1;
      width: 100%;
      height: 100%;
      opacity: 0.3;
      position: absolute;
      transform-style: preserve-3d;
      -webkit-transition: opacity calc(var(--animation-speed) * 3) ease-out;
      -moz-transition: opacity calc(var(--animation-speed) * 3) ease-out;
      -o-transition: opacity calc(var(--animation-speed) * 3) ease-out;
      transition: opacity calc(var(--animation-speed) * 3) ease-out;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark4) 100%);
      /*mix-blend-mode: hue;*/
    }
    *:hover #gradient {
      opacity: 0.1;
      background-color: cyan;
    }
    #background-image {
      top: 0%;
      z-index: -10;
      width: 100%;
      height: 100%;
      position: absolute;
      transform-style: preserve-3d;
      box-shadow: 0.25rem 0.25rem 2rem var(--color-primary-dark5);
    }
  </style>
  <div id="container">
    <div id="gradient"></div>
    <slot id="content"></slot>
  </div>
</template>
<script>
  const perspectiveCardDocument = document.currentScript.ownerDocument

  window.customElements.define('perspective-card', class extends window.HTMLElement {
    constructor() {
      super()
      const htmlStyles = window.getComputedStyle(document.querySelector('html'))
      this.animationSpeed = parseInt(htmlStyles.getPropertyValue('--animation-speed').slice(0, -2))
      this.template = perspectiveCardDocument.querySelector('#template').content.cloneNode(true)
      this.shadowDOM = this.attachShadow({ mode: 'open' })
      this.shadowDOM.appendChild(this.template)
      this.containerElement = this.shadowDOM.querySelector('#container')
      this.frameCount = 0
      this.frameSkip = 4
    }

    connectedCallback() {
      this.addEventListener('click', this._clickHandler, { passive: true })
      this.addEventListener('mouseenter', this._mouseenterHandler, { passive: true })
      this.addEventListener('mousemove', this._mousemoveHandler, { passive: true, capture: true })
      this.addEventListener('mouseleave', this._mouseleaveHandler, { passive: true })
    }

    disconnectedCallback() {
      this.removeEventListener('click', this._clickHandler)
      this.removeEventListener('mouseenter', this._mouseenterHandler)
      this.removeEventListener('mousemove', this._mousemoveHandler)
      this.removeEventListener('mouseleave', this._mouseleaveHandler)
    }

    _clickHandler(event) {
      page(this.postURL)
    }

    _mouseenterHandler(event) {
      this.containerElement.classList.remove('slow')
    }

    _mousemoveHandler(event) {
      if (this.frameCount < this.frameSkip) {
        window.requestAnimationFrame(() => {
          this.frameCount++
        })
      } else {
        const self = this
        window.requestAnimationFrame(() => {
          const width = self.clientWidth
          const height = self.clientHeight
          const scrollOffset = self.offsetParent.offsetTop + self.offsetTop - window.pageYOffset

          // offset from center of card, range(-0.5, 0.5)
          const xOffset = ((event.clientX - self.offsetLeft) / width) - 0.5
          const yOffset = ((event.clientY - scrollOffset) / height) - 0.5

          self._setCustomProperties(xOffset, yOffset)
          self.frameCount = 0
        })
      }
    }

    _mouseleaveHandler(event) {
      // reset card rotation after a short delay
      this.containerElement.classList.add('slow')
      setTimeout(() => {
        this.frameCount = 0
        this._setCustomProperties(0, 0)
      }, this.animationSpeed * 2)
    }

    _setCustomProperties(xOffset, yOffset) {
      this.style.setProperty('--x-offset', xOffset)
      this.style.setProperty('--y-offset', yOffset)
    }

    static get observedAttributes() {
      return ['background-image', 'post-url']
    }

    attributeChangedCallback(attr, oldValue, newValue) {
      if (attr === 'background-image' && newValue.includes('.')) {
        this.backgroundImage = new window.Image()
        this.backgroundImage.id = 'background-image'
        this.backgroundImage.src = newValue
        this.containerElement.appendChild(this.backgroundImage)
      } else if (attr === 'post-url') {
        this.postURL = newValue
      }
    }
  })
</script>
</html>
